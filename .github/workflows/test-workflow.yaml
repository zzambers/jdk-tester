name: "test"

on:
  push:
    branches:
      - "jdk*"
    tags:
      - "jdk*"

jobs:
  test-jdk:
    name: "Test JDK"
    runs-on: "ubuntu-latest"
    steps:
      - uses: actions/checkout@v2
      - name: read config
        run: |
          . CONFIG
          [ -n "${JDK_REPO}" ]
          [ -n "${JDK_REF}" ]
          [ -n "${JDK_TEST}" ]
          echo "JDK_REPO=${JDK_REPO}" >> $GITHUB_ENV
          echo "JDK_REF=${JDK_REF}" >> $GITHUB_ENV
          echo "JDK_TEST=${JDK_TEST}" >> $GITHUB_ENV
      - name: clone jdk
        uses: actions/checkout@v2
        with:
          repository: ${{ env.JDK_REPO }}
          path: jdk
          ref: ${{ env.JDK_REF }}
      - name: system info
        run: |
          uname -a
          cat /proc/cpuinfo
      - name: Detect JDK version
        run: |
          . ./helper-funcs.sh
          detectVersionsGH
      - name: Install boot jdk
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: ${{ env.BOOT_JDK_VER }}
      - name: Install build deps
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install build-essential gcc-9-multilib g++-9-multilib libfreetype6-dev:i386 libcups2-dev:i386 libx11-dev:i386 libxext-dev:i386 libxrender-dev:i386 libxrandr-dev:i386 libxtst-dev:i386 libxt-dev:i386 libasound2-dev:i386 libffi-dev:i386 autoconf
      - name: Prepare Jtreg
        run: |
          . ./helper-funcs.sh
          prepareJtreg
      - name: Configure JDK
        run: |
          . ./helper-funcs.sh
          conigureJdk
      - name: Build JDK
        run: |
          . ./helper-funcs.sh
          buildJdk
      - name: Test JDK
        run: |
          . ./helper-funcs.sh
          testJdk
      - name: Pack results
        if: always()
        run: |
          . ./helper-funcs.sh
          packResults
        continue-on-error: true
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v2
        with:
          path: test-results.tar.gz
        continue-on-error: true
