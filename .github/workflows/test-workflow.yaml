name: "test"

on:
  push:
    branches:
      - "jdk*"
    tags:
      - "jdk*"

jobs:
  test-jdk-win:
    name: "Test JDK Win32"
    runs-on: "windows-2019"
    steps:
      - uses: actions/checkout@v2
      - name: Restore cygwin installer from cache
        id: cygwin-installer
        uses: actions/cache@v3
        with:
          path: ~/cygwin/setup-x86_64.exe
          key: cygwin-installer

      - name: Download cygwin installer
        run: |
          New-Item -Force -ItemType directory -Path "$HOME\cygwin"
          & curl -L "https://www.cygwin.com/setup-x86_64.exe" -o "$HOME/cygwin/setup-x86_64.exe"
        if: steps.cygwin-installer.outputs.cache-hit != 'true'
      - name: Restore cygwin packages from cache
        id: cygwin
        uses: actions/cache@v3
        with:
          path: ~/cygwin/packages
          key: cygwin-packages-${{ runner.os }}-v1

      - name: Install cygwin
        run: |
          Start-Process -FilePath "$HOME\cygwin\setup-x86_64.exe" -ArgumentList "--quiet-mode --packages autoconf,make,zip,unzip --root $HOME\cygwin\cygwin64 --local-package-dir $HOME\cygwin\packages --site http://mirrors.kernel.org/sourceware/cygwin --no-desktop --no-shortcuts --no-startmenu --no-admin" -Wait -NoNewWindow
      - name: clone jdk
        uses: actions/checkout@v3
        with:
          repository: zzambers/jdk11u-dev
          path: jdk
          ref: vs2010-fix
      - name: Install boot jdk
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 11
      - name: Prepare Jtreg
        run: |
          $env:Path = "$HOME\cygwin\cygwin64\bin;$env:Path" ;
          curl -L -f -o jtreg.zip "https://builds.shipilev.net/jtreg/jtreg-6.1+2.zip" ;
          & unzip jtreg.zip
      - name: Uninstall WinSDKs
        run: >
          Start-Process -FilePath 'C:\Program Files (x86)\Microsoft Visual Studio\Installer\vs_installer.exe' -Wait -NoNewWindow -ArgumentList
          'modify --installPath "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise"
          --remove Microsoft.VisualStudio.Component.Windows10SDK.18362
          --remove Microsoft.VisualStudio.Component.Windows10SDK.19041
          --remove Microsoft.VisualStudio.Component.Windows10SDK.20348
          --remove Microsoft.VisualStudio.Component.Windows10SDK.22000
          --quiet'
      - name: Restore Visual Studio 2017 from cache
        id: vs2017
        uses: actions/cache@v3
        with:
          path: ~/vs2017.exe
          key: vs2017
      - name: Download Visual Studio 2017
        run: |
          curl -L "https://github.com/akashche/msvs_2017_installer_bootstrap/raw/master/vs_community__7955ddbf8a9b49dda0f8d18876e93bd2.exe" -o "$HOME/vs2017.exe"
        if: steps.vs2017.outputs.cache-hit != 'true'
      - name: Install Visual Studio 2017
        run: >
          Start-Process -FilePath "$HOME\vs2017.exe" -Wait -NoNewWindow -ArgumentList
          'install --productId Microsoft.VisualStudio.Product.Community --channelId VisualStudio.15.Release
          --add Microsoft.VisualStudio.Workload.NativeDesktop
          --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64
          --add Microsoft.VisualStudio.Component.Windows10SDK.17763
          --quiet --wait'
      - name: Configure JDK
        run: >
          $env:Path = "$HOME\cygwin\cygwin64\bin;$HOME\cygwin\cygwin64\bin;$env:Path" ;
          $env:Path = $env:Path -split ";" -match "C:\\Windows|PowerShell|cygwin" -join ";" ;
          $env:BOOT_JDK = cygpath "$env:JAVA_HOME" ;
          $env:JT_HOME = cygpath "$env:GITHUB_WORKSPACE/jtreg" ;
          & bash configure
          --with-toolchain-version=2017
          --with-target-bits=32
          --with-boot-jdk="$env:BOOT_JDK"
          --with-jtreg="$env:JT_HOME" ;
          bash -c "cat $(find -name config.log)"
        working-directory: jdk
      - name: Build JDK
        run: |
          $env:Path = "$HOME\cygwin\cygwin64\bin;$HOME\cygwin\cygwin64\bin;$env:Path" ;
          $env:Path = $env:Path -split ";" -match "C:\\Windows|PowerShell|cygwin" -join ";" ;
          & make images
        working-directory: jdk
      - name: Test JDK
        run: >
          $env:Path = "$HOME\cygwin\cygwin64\bin;$HOME\cygwin\cygwin64\bin;$env:Path" ;
          $env:Path = $env:Path -split ";" -match "C:\\Windows|PowerShell|cygwin" -join ";" ;
          & make run-test "TEST=hotspot_tier1"
        working-directory: jdk
      - name: Pack results
        if: always()
        run: |
          $env:Path = "$HOME\cygwin\cygwin64\bin;$env:Path" ;
          tar -C jdk/build/* -czf "test-results.tar.gz" test-results test-support
        continue-on-error: true
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v2
        with:
          path: test-results.tar.gz
        continue-on-error: true


  test-jdk:
    name: "Test JDK"
    runs-on: "ubuntu-latest"
    if: false
    steps:
      - uses: actions/checkout@v2
      - name: read config
        run: |
          . CONFIG
          [ -n "${JDK_REPO}" ]
          [ -n "${JDK_REF}" ]
          [ -n "${JDK_TEST}" ]
          echo "JDK_REPO=${JDK_REPO}" >> $GITHUB_ENV
          echo "JDK_REF=${JDK_REF}" >> $GITHUB_ENV
          echo "JDK_TEST=${JDK_TEST}" >> $GITHUB_ENV
      - name: clone jdk
        uses: actions/checkout@v2
        with:
          repository: ${{ env.JDK_REPO }}
          path: jdk
          ref: ${{ env.JDK_REF }}
      - name: system info
        run: |
          uname -a
          cat /proc/cpuinfo
      - name: Detect JDK version
        run: |
          . ./helper-funcs.sh
          detectVersionsGH
      - name: Install boot jdk
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: ${{ env.BOOT_JDK_VER }}
      - name: Install build deps
        run: |
          sudo apt-get install build-essential libfreetype6-dev libcups2-dev libx11-dev libxext-dev libxrender-dev libxrandr-dev libxtst-dev libxt-dev libasound2-dev libffi-dev autoconf
      - name: Prepare Jtreg
        run: |
          . ./helper-funcs.sh
          prepareJtreg
      - name: Configure JDK
        run: |
          . ./helper-funcs.sh
          conigureJdk
      - name: Build JDK
        run: |
          . ./helper-funcs.sh
          buildJdk
      - name: Test JDK
        run: |
          . ./helper-funcs.sh
          testJdk
      - name: Pack results
        if: always()
        run: |
          . ./helper-funcs.sh
          packResults
        continue-on-error: true
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v2
        with:
          path: test-results.tar.gz
        continue-on-error: true
